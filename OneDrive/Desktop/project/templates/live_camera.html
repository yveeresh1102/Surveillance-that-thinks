<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Camera</title>


  <style>
    body { 
      background: #000; 
      color: #fff; 
      font-family: Arial; 
      text-align:center; 
      margin:0;
      padding:0;
    }
    img#stream { 
      width: 85%; 
      border: 4px solid cyan; 
      margin-top:20px; 
      border-radius:8px; 
    }
    .popup { 
      position: fixed; 
      right: 20px; 
      top: 80px; 
      background: rgba(255,0,0,0.9); 
      color: #fff; 
      padding: 12px 18px; 
      border-radius: 6px; 
      display:none; 
      z-index:9999; 
      font-size: 15px;
      box-shadow: 0 0 10px red;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      background: cyan;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #00a0a0;
    }
  </style>
</head>

<body>

  <h1>Live Threat Detection</h1>
  <h2 id="camName"></h2>

  <img id="stream" src="" alt="live feed">

  <div class="popup" id="alertPopup"></div>

  <!-- Back Button -->
  <button onclick="goBack()">Back to Dashboard</button>

  <!-- Load alert sound from Flask static folder -->
  <audio id="alertSound" src="{{ url_for('static', filename='alert_sound.mp3') }}"></audio>

  <script>
    // Read camera parameter
    const params = new URLSearchParams(window.location.search);
    const camera = params.get('camera') || '0';

    // Label camera dynamically
    document.getElementById('camName').innerText = 
      (camera.startsWith("rtsp") ? "IP Stream" : "Camera " + camera);

    // Build stream URL
    const streamUrl = "/video_feed?camera=" + encodeURIComponent(camera);
    document.getElementById("stream").src = streamUrl;

    // SSE: Receive real-time alerts
    const evtSource = new EventSource("/alerts");

    evtSource.onmessage = function(e) {
      try {
        const data = JSON.parse(e.data);

        // Match only alerts for this camera
        if (String(data.camera) === String(camera)) {
          showPopup(data);
        }
      } catch (err) {
        console.error("SSE Parse Error:", err);
      }
    };

    // Show threat popup
    function showPopup(obj) {
      const popup = document.getElementById("alertPopup");

      popup.innerHTML = `
        <strong>âš  ALERT DETECTED!</strong><br>
        Camera: ${obj.camera}<br>
        Threat: ${obj.threat_type}<br>
        Confidence: ${obj.confidence}<br>
        <a href="${obj.clip}" target="_blank" style="color:yellow;">View Clip</a>
      `;

      popup.style.display = "block";

      // Play alert sound
      document.getElementById("alertSound").play().catch(()=>{});

      // Hide after 10 seconds
      setTimeout(() => popup.style.display = "none", 10000);
    }

    // Navigate back safely
    function goBack(){
      window.location.href = "{{ url_for('dashboard') }}";
    }
  </script>

</body>
</html>
